\documentclass{notes}

\title{Discretisation of position and momentum}
\author{}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage[
    backend=biber,
    sorting=none,
    style=numeric-comp,
    citestyle=numeric-comp
]{biblatex}
\addbibresource{ref.bib}

\newcommand{\DREAM}{\textsc{Dream}}
\newcommand{\FVM}{\textsc{Fvm}}
\newcommand{\nRE}{n_{\rm RE}}
\newcommand{\Vp}{\mathcal{V}'}
\newcommand{\Jac}{\mathsf{J}}

\begin{document}
    \maketitle

    \noindent
    This document describes the (spatial/momentum) discretisations used in \DREAM.
    The overarching scheme used for deriving discretisations is the so-called
    finite-volume method (FVM).

    \tableofcontents

    \section{Grid definition}
    The most general grid used in \DREAM\ consists of three coordinates: one
    spatial coordinate $x$ and two momentum coordinates, $p_1$ and $p_2$. For
    a general coordinate $z^{(\alpha)}$, we introduce $N_\alpha$ cell grid points and
    $N_\alpha+1$ flux grid points and impose the definitions
    \begin{equation}
        \begin{aligned}
            \text{Flux grid:} & \qquad z^{(\alpha)}_{\rm min} = z^{(\alpha)}_{1/2} < z^{(\alpha)}_{3/2} < \ldots < z^{(\alpha)}_{N_\alpha+1/2} = z^{(\alpha)}_{\rm max},\\
            \text{Cell grid:} & \qquad z^{(\alpha)}_i = \frac{z^{(\alpha)}_{i+1/2} + z^{(\alpha)}_{i-1/2}}{2}, \quad (1\leq i \leq N_\alpha)\\
            &\qquad \Delta z^{(\alpha)}_i = z^{(\alpha)}_{i+1/2} - z^{(\alpha)}_{i-1/2}, \quad (1\leq i \leq N_\alpha)\\
            &\qquad \Delta z^{(\alpha)}_{i-1/2} = z^{(\alpha)}_i - z^{(\alpha)}_{i-1},\quad (2\leq i \leq N_\alpha).
        \end{aligned}
    \end{equation}

    \section{Boundary conditions}
    This section describes the various boundary conditions used in the code.
    In momentum space, the internal boundary conditions can be described from
    the distribution function symmetry relations
    \begin{equation}\label{eq:fsymmetry}
        \begin{aligned}
            f(-p,\theta) &= f(p,\pi-\theta),\\
            f(p,-\theta) &= f(p,\theta).
        \end{aligned}
    \end{equation}

    \subsection{Boundary conditions on $p/\xi$ grids}
    From the first of the symmetry relations~\eqref{eq:fsymmetry}, we find that
    that the flux through $p=0$ along a given pitch direction must be equal on
    both sides, implying that
    \begin{equation}
        \Phi^{(p)}\left(p=0^+, \xi\right) = \Phi^{(p)}\left(p=0^-, -\xi\right).
    \end{equation}

    From the second of the symmetry relations~\eqref{eq:fsymmetry}, we
    immediately find that the fluxes across the $\xi=\pm1$ boundaries vanish,
    i.e.\
    \begin{equation}\label{eq:bc:xiInternal}
        \Phi^{(\xi)}(p, \xi=1) = \Phi^{(\xi)}(p, \xi=-1) = 0.
    \end{equation}

    For external boundary conditions, we need to consider two cases. In the
    first case, the region above $p=p_{\rm max}$ is modelled as a fluid, and we
    thus only count the radial density $\nRE$ of runaway electrons. This
    means that we must count the flux through the $p=p_{\rm max}$ boundary, so
    that
    \begin{equation}
        \frac{\partial \nRE}{\partial t} =
        \int_{-1}^1 \Phi^{(p)}\left(p_{\rm max}, \xi\right)\,\frac{\Vp(r,p_{\rm max},\xi)}{V'(r)}\,\dd\xi.
    \end{equation}
    To evaluate $\Phi^{(p)}(p_{\rm max},\xi)$, which results from a combination
    of advection and diffusion on the momentum grid, we generally need to know
    the distribution function $f$ on both sides of $p=p_{\rm max}$. Since we do
    not keep track of $f$ above $p=p_{\rm max}$, we will need handle this in a
    special way. For the advection term, we simply set the interpolation
    coefficient $\delta_{N_p+1} = 0$, so that only the value of $f$ in
    $p=p_{N_p-1/2}$ is used. This could potentially cause problems with
    the preservation of positivity, and \red{we might want to consider other
    methods in the future.} For the diffusion term, however, no such simple fix
    exists, and we instead choose to interpolate in the flux:
    \begin{equation}
        \begin{aligned}
            \Phi^{(p)}_{N_p-1/2} &= \Phi^{(p)}_{N_p+1/2} - \Delta p_{N_p}\Phi^{\prime(p)}_{N_p+1/2},\\
            \Phi^{(p)}_{N_p-3/2} &= \Phi^{(p)}_{N_p+1/2} - (\Delta p_{N_p}+\Delta p_{N_p-1})
            \Phi^{\prime(p)}_{N_p+1/2},
        \end{aligned}
    \end{equation}
    where $\Phi^{\prime(p)} = \partial\Phi^{(p)}/\partial p$. Solving for
    $\Phi^{(p)}_{N_p+1/2}$ we obtain
    \begin{equation}
        \Phi^{(p)}_{N_p+1/2} = \Phi^{(p)}_{N_p-1/2} +
        \frac{\Delta p_{N_p}}{\Delta p_{N_p-1}} \left( \Phi^{(p)}_{N_p-1/2} - \Phi^{(p)}_{N_p-3/2} \right).
    \end{equation}

    In the second case, when the runaway grid is enabled, we want the flux
    across the hot-tail $p=p_{\rm max}$ to enter (or leave) the runaway grid
    seamlessly. If the hot-tail and runaway grids have the same $\xi$ grids,
    this is rather straightforward as we simply set 
    $\Phi^{(p)}_{\rm hot}(p_{\rm max},\xi) = \Phi^{(p)}_{\rm RE}(p_{1/2},\xi)$.
    However, in \DREAM, we allow for the two grids to be different (we only
    enforce $p^{\rm RE}_{1/2} = p^{\rm hot}_{\rm max}$) and so we must connect
    the two grids in some way. We can achieve this by setting
    \begin{equation}
        \Phi^{(p)}_{\rm RE}(p_{1/2},\xi_j)\Vp_{j,\rm RE}\Delta\xi_{j,\rm RE} =
        \sum_{J} \Phi^{(p)}_{\rm hot}(p_{\rm max},\xi_J) \Vp_{J,\rm hot} \overline{\Delta\xi}_{jJ,\rm hot},
    \end{equation}
    where the modified grid step $\overline{\Delta\xi}_{jJ,\rm hot}$ is defined
    as
    \begin{equation}\label{eq:PhiPinterp}
        \overline{\Delta\xi}_{jJ,\rm hot} = \min\left(\xi_{J+1/2,{\rm hot}},\xi_{j+1/2,{\rm RE}}\right) -
        \max\left( \xi_{J-1/2,{\rm hot}}, \xi_{j-1/2,{\rm RE}} \right),
    \end{equation}
    so that $\Delta\xi_{j,\rm RE} = \sum\overline{\Delta\xi}_{jJ,\rm hot}$, and
    the particle number is conserved. The sum in equation~\eqref{eq:PhiPinterp}
    ranges over all $\xi_J\in [\xi_{j-1/2},\xi_{j+1/2}]$.

    \section{Spatial discretisations}
    In this section we describe the various discretisations used in \DREAM. We
    however begin by describing the general approach taken to discretising
    equations in the code.

    \subsection{Finite volume method}
    In order to achieve mass conservation, we use the finite-volume method to
    discretise our equations and consider the fluxes between cells on the
    computational grid. For a general flux-conservative term
    $\nabla\cdot\bb{\Phi}$, we take the matrix row corresponding to element
    $i_1\cdots i_D$ ($D$ being the problem dimensionality) of the unknown
    quantity to be
    \begin{equation}
        \left[ \nabla\cdot\bb{\Phi} \right]_{i_1\cdots i_D}  =
            \frac{1}{\Vp_{i_1\cdots i_D}}\sum_\beta \frac{
                \Phi^{(\beta)}_{i_\beta+1/2} \Vp_{i_\beta+1/2} -
                \Phi^{(\beta)}_{i_\beta-1/2} \Vp_{i_\beta-1/2}
            }{\Delta z^{(\beta)}_{i_\beta}},
    \end{equation}
    where $\Vp$ denotes the phase space Jacobian, Greek indices denote the
    coordinate (i.e.\ $z_\alpha, z_\beta, \ldots$), Latin indices denote grid
    points and the matrix indices which are not shifted have been suppressed for
    clarity (i.e.\
    $\Phi^{(\beta)}_{i_\beta+1/2}\equiv\Phi^{(\beta)}_{i_1\cdots i_\beta+1/2\cdots i_D}$).

    \subsection{Advection term}\label{sec:advection}
    A general advection term can be written on the form
    \begin{equation*}
        \nabla\cdot\left( \bb{F} f \right),
    \end{equation*}
    with $\bb{F} = \zhat^{(\alpha)}F^{(\alpha)} + \zhat^{(\beta)}F^{(\beta)}+\ldots$
    denoting the advection coefficient and $f$ the distribution function. For
    momentum-space friction, we discretise such terms according to
    \begin{equation}\label{eq:advection:discr}
        \left[\nabla\cdot\left( \bb{F}f \right) \right]_{i_1\cdots i_D} =
            \frac{1}{\Vp_{i_1\cdots i_D}}\sum_\beta \frac{
                F^{(\beta)}_{i_\beta+1/2}f_{i_\beta+1/2} \Vp_{i_\beta+1/2} -
                F^{(\beta)}_{i_\beta-1/2}f_{i_\beta-1/2} \Vp_{i_\beta-1/2}
            }{\Delta z^{(\beta)}_{i_\beta}},
    \end{equation}
    Since the distribution function is only known on the cell grid, but is here
    required on the flux grid, we must interpolate. We interpolate linearly in
    $f$ according to
    \begin{equation}
        f_{i_\beta-1/2} = \delta^{(\beta)}_{i_\beta} f_{i_\beta} + \left( 1 - \delta^{(\beta)}_{i_\beta} \right) f_{i_\beta-1},
    \end{equation}
    where the interpolation coefficients $\delta^{(\beta)}_{i_\beta}$ are
    determined with the help of any of the methods described in
    section~\ref{sec:interp}. (Note that unnecessary indices have been
    suppressed, so that really
    $\delta^{(\beta)}_{i_\beta} = \delta^{(\beta)}_{i_1\cdots i_\beta\cdots i_D}$).

    \subsubsection{Boundary conditions on $p/\xi$ grid}
    Internal boundary conditions at $p=p_{1/2}$ must be specified explicitly.
    They must then be inserted appropriately into~\eqref{eq:advection:discr} so
    that
    \begin{equation}
        \left[ \nabla\cdot\left( \bb{F}f \right) \right]_{1,j} = \frac{
            \Vp_{3/2} F_{3/2}^{(p)} f_{3/2} - \Vp_{1/2}\Phi^{(p)}_{1/2}
        }{\Delta p_{1}}
    \end{equation}
    where $\Phi_{1/2}^{(p)}$ is the phase space particle flux into or out of
    the inner boundary. At $\xi=\xi_{1/2}$ and $\xi=\xi_{N_\xi+1/2}$, however,
    we use the result~\eqref{eq:bc:xiInternal} and obtain (for the $\xi$ term)
    \begin{equation}
        \begin{aligned}
            \left[ \nabla\cdot\left( \bb{F} f \right) \right]_{i,1} &=
                \frac{\Vp_{3/2} F^{(\xi)}_{i,3/2} f_{i,3/2}}{\Delta\xi_{1}},\\
            %
            \left[ \nabla\cdot\left( \bb{F} f \right) \right]_{i,N_\xi} &=
                -\frac{\Vp_{N_\xi-1/2} F^{(\xi)}_{i,N_\xi-1/2} f_{i,N_\xi-1/2}}{\Delta\xi_{N_\xi}}.
        \end{aligned}
    \end{equation}

    \subsubsection{Boundary conditions on $p_\parallel / p_\perp$ grid}
    \emph{To be written...}

    \subsection{Diffusion term}\label{sec:diffusion}
    A general diffusion term can be written on the form
    \begin{equation*}
        \nabla\cdot\left( \mathbb{D}\cdot\nabla f \right),
    \end{equation*}
    where $\mathbb{D}$ is the diffusion tensor
    \begin{equation*}
        \mathbb{D} = \begin{pmatrix}
            D_{rr} & D_{r1} & D_{r2} \\
            D_{1r} & D_{11} & D_{12} \\
            D_{2r} & D_{21} & D_{22}
        \end{pmatrix}.
    \end{equation*}
    In \DREAM, we neglect the radial cross-terms, i.e.\
    $D_{r1} = D_{1r} = D_{r2} = D_{2r} = 0$.

    For the diffusion term, we will need to approximate derivatives of the
    distribution function $f$. For the diagonal terms (i.e.\ the $D_{rr}$,
    $D_{11}$ and $D_{22}$ terms), this is straightforward: since the derivatives
    should be evaluated on the flux grid, we can use a basic central difference
    approximation:
    \begin{align}
        \left.\frac{\partial f}{\partial r}\right|_{k-1/2,i,j} &=
            \frac{f_{k,i,j} - f_{k-1,i,j}}{\Delta r_{k-1/2}},\\
        %
        \left.\frac{\partial f}{\partial p_1}\right|_{k,i-1/2,j} &=
            \frac{f_{k,i,j} - f_{k,i-1,j}}{\Delta p_{1; i-1/2}},\\
        %
        \left.\frac{\partial f}{\partial p_2}\right|_{k,i,j-1/2} &=
            \frac{f_{k,i,j} - f_{k,i,j-1}}{\Delta p_{2; j-1/2}},\\
    \end{align}
    Since no interpolation in $f$ is needed, these terms automatically preserve
    the positivity of the solution.

    The cross terms cause some problems with preservation of positivity.
    Unfortunately we cannot use the same interpolation scheme as for the
    advection term. To easily support the use of diffusion cross terms, we
    therefore use simple cell averaging, which does \emph{not} preserve
    positivity. We write the derivatives as
    \begin{equation}
        \begin{aligned}
            \left.\frac{\partial f}{\partial p_1}\right|_{k,i,j-1/2} &=
                \frac{f_{i+1,j} + f_{i+1,j-1} - f_{i-1,j} - f_{i-1,j-1}}
                {\Delta p_{1;i+1/2} + \Delta p_{1;i-1/2}},\\
            %
            \left.\frac{\partial f}{\partial p_2}\right|_{k,i-1/2,j} &=
                \frac{f_{i,j+1} + f_{i-1,j+1} - f_{i,j-1} - f_{i-1,j-1}}
                {\Delta p_{2;j+1/2} + \Delta p_{2;j-1/2}}.
        \end{aligned}
    \end{equation}
    If we would like to also preserve positivity, we should instead use the
    approach taken by refs.~\cite{DuToit2018,Daniel2019}. They rewrite the
    diffusion cross terms as advection terms, which allows us to use the same
    methods as in section~\ref{sec:advection}. The ``advection form'' for the
    diffusion cross terms is
    \begin{equation}
        \begin{aligned}
            \left[ D_{12}\frac{\partial f}{\partial p_2} \right] &=
                \frac{\partial (\ln f)}{\partial p_2}D_{12} f = \tilde{D}_{12} f,\\
            %
            \left[ D_{21}\frac{\partial f}{\partial p_1} \right] &=
                \frac{\partial (\ln f)}{\partial p_1}D_{21} f = \tilde{D}_{21} f,
        \end{aligned}
    \end{equation}
    where we have introduced the modified diffusion coefficients
    $\tilde{D}_{12}\equiv D_{12}\partial(\ln f)/\partial p_2$ and
    $\tilde{D}_{21}\equiv D_{21}\partial(\ln f)/\partial p_1$. These modified
    diffusion coefficients depend on (non-linearly) on the unknown, and hence
    they require a non-linear solver. We choose not to implement this form of
    the diffusion coefficients directly in the \DREAM/\FVM\ library, but instead
    refer to the physicist to rewriting her equations according to the above
    and implement them using the advection term class instead.

    \paragraph{Full discretisation}
    Within the framework of the finite-volume method, we discretise the general
    diffusion term as
    \begin{equation}
        \begin{aligned}
            \left[ \nabla\cdot\left( \mathbb{D}\cdot\nabla f \right) \right]_{kij} &=
                \frac{1}{\Vp_{i_1\cdots i_D}}\Bigg[\\
                %
                &\frac{1}{\Delta r_k}\left(
                    \Vp_{k+1/2}D_{rr;k+1/2}\frac{f_{k+1,i,j}-f_{k,i,j}}{\Delta r_{k+1/2}} -
                    \Vp_{k-1/2}D_{rr;k-1/2}\frac{f_{k,i,j}-f_{k-1,i,j}}{\Delta r_{k-1/2}}
                \right) +\\
                %
                &+ \frac{1}{\Delta p_{1;i}} \left(
                    \Vp_{i+1/2}D_{11;i+1/2}\frac{f_{k,i+1,j} - f_{k,i,j}}{\Delta p_{1;i+1/2}} -
                    \Vp_{i-1/2}D_{11;i-1/2}\frac{f_{k,i,j} - f_{k,i-1,j}}{\Delta p_{1;i-1/2}}
                \right) +\\
                %
                &+ \frac{1}{\Delta p_{2;i}} \left(
                    \Vp_{j+1/2}D_{22;j+1/2}\frac{f_{k,i,j+1} - f_{k,i,j}}{\Delta p_{2;j+1/2}} -
                    \Vp_{j-1/2}D_{22;j-1/2}\frac{f_{k,i,j} - f_{k,i,j-1}}{\Delta p_{2;j-1/2}}
                \right) +\\
                %
                &+ \Vp_{i+1/2}D_{12;i+1/2}\frac{
                    f_{k,i+1,j+1} + f_{k,i,j+1} - f_{k,i+1,j-1} - f_{k,i,j-1}
                }{\Delta p_{1;i}\left(\Delta p_{2;j+1/2} + \Delta p_{2;j-1/2} \right)} -\\
                &- \Vp_{i-1/2}D_{12;i-1/2}\frac{
                    f_{k,i,j+1} + f_{k,i-1,j+1} - f_{k,i,j-1} - f_{k,i-1,j-1}
                }{\Delta p_{1;i}\left(\Delta p_{2;j+1/2} + \Delta p_{2;j-1/2} \right)} +\\
                %
                &+ \Vp_{j+1/2}D_{21;j+1/2}\frac{
                    f_{k,i+1,j+1} + f_{k,i+1,j} - f_{k,i-1,j+1} - f_{k,i-1,j}
                }{\Delta p_{2;j}\left(\Delta p_{1;i+1/2} + \Delta p_{1;i-1/2} \right)} -\\
                &- \Vp_{j-1/2}D_{21;j-1/2}\frac{
                    f_{k,i+1,j} + f_{k,i+1,j-1} - f_{k,i-1,j} - f_{k,i-1,j-1}
                }{\Delta p_{2;j}\left(\Delta p_{1;i+1/2} + \Delta p_{1;i-1/2} \right)}\\
            &\Bigg].
        \end{aligned}
    \end{equation}

    \section{Interpolating in distribution function}\label{sec:interp}
    In advection terms, as well as diffusion cross terms, we must evaluate the
    distribution function on the flux grid. Since the distribution function is
    only explicitly computed on the cell grid, this means that we must
    interpolate in the distribution function. We use linear interpolation and
    write generally
    \begin{equation}
        f_{i-1/2} = \delta_{i} f_i + \left( 1 - \delta_i \right) f_{i-1}.
    \end{equation}
    In the simplest approach, we take $\delta_i\equiv 1/2$, making $f_{i-1/2}$
    a simple average of the value of $f$ in the adjacent cells. While simple and
    often accurate enough, other schemes for choosing $\delta_i$ can provide
    better stability and even desirable physical properties such as preservation
    of positivity. These schemes are referred to as ``flux limiter schemes'',
    and we also provide those in the code.

    \subsection{Flux limiter schemes}

    \section{Solution of non-linear system}
    The set of equations we aim to solve can generally be formulated as the
    root-finding problem,
    \begin{equation}\label{eq:nonlinear}
        \bb{F}(\bb{x}) = 0,
    \end{equation}
    where $\bb{F}$ represents the physical equations to solve. A number of
    approaches could be imagined for solving this equation, and in this section
    we will review those implemented in \DREAM.

    \subsection{Linearly implicit solution}
    The linearly implicit solution method relies on the slow time evolution of
    the system in question. Let us assume that $\bb{F}$ may be decomposed into
    \begin{equation}
        \bb{F}\left( \bb{x} \right) = M\left( \bb{x} \right) \bb{x} + S\left( \bb{x} \right)
    \end{equation}
    where $M$ takes the form of a linear operator which may depend non-linearly
    on $\bb{x}$, and $S$ takes the form of a source term. In a linearly implicit
    scheme, one assumes that $M$ and $S$ depend weakly on $\bb{x}$, thus
    justifying the approximation
    \begin{equation}
        \bb{F}\left( \bb{x}_{n+1} \right)\approx M\left( \bb{x}_n\right) \bb{x}_{n+1}
        + S\left( \bb{x}_n \right).
    \end{equation}
    In this approximation, equation~\eqref{eq:nonlinear} may be solved by
    inverting the matrix $M$:
    \begin{equation}
        \bb{x}_{n+1} = M^{-1}\left(\bb{x}_n\right) S\left(\bb{x}_n\right).
    \end{equation}
    In contrast to the more accurate Newton method, the linearly implicit scheme
    requires no iteration, and thus only one matrix inversion. This can make the
    scheme beneficial for evolving systems which vary slowly in time.
    
    \subsection{Newton's method}
    The more general \emph{Newton's method} is obtained by Taylor expanding
    equation~\eqref{eq:nonlinear} around $\bb{x}^{(k+1)} = \bb{x}^{(k)} + \Delta\bb{x}$:
    \begin{equation}
        \bb{F}\left( \bb{x}^{(k+1)} \right)\approx \bb{F}\left(\bb{x}^{(k)}\right) +
        \Jac\left(\bb{x}^{(k)}\right) \left( \bb{x}^{(k+1)} - \bb{x}^{(k)} \right) = 0.
    \end{equation}
    Here, $\Jac(\bb{x}^{(k)}) = \partial\bb{F}(\bb{x}^{(k)})/\partial\bb{x}$
    denotes the Jacobian matrix of $\bb{F}$. Solving for $\bb{x}^{(k+1)}$, we
    obtain the iterative scheme
    \begin{equation}
        \bb{x}^{(k+1)} = \bb{x}^{(k)} - \Jac^{-1}\left( \bb{x}^{(k)} \right) \bb{F}\left( \bb{x}^{(k)} \right),
    \end{equation}
    which hopefully converges to the true zero of $\bb{F}$. Here, we thus rely
    on a series of iterations to obtain the true solution in any given time
    step.

    The most difficult part of Newton's method is evaluating the Jacobian
    $\Jac$.

    \addcontentsline{toc}{section}{References}
    \printbibliography

\end{document}

